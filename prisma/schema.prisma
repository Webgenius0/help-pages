// This is your Prisma schema file for MySQL
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  email     String   @unique
  password  String
  fullName  String?  @map("full_name")
  avatarUrl String?  @map("avatar_url")
  bio       String?  @db.Text
  role      String   @default("viewer") // 'admin' | 'editor' | 'viewer'
  isPublic  Boolean  @default(true) @map("is_public")
  createdBy String?  @map("created_by") // ID of the admin who created this user
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  docs          Doc[]
  pages         Page[]
  accounts      Account[]
  sessions      Session[]
  pageRevisions PageRevision[]

  @@index([createdBy])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Doc = Documentation Project/Product (like Supabase docs)
model Doc {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  title       String
  slug        String   @unique
  description String?  @db.Text
  isPublic    Boolean  @default(true) @map("is_public")
  theme       Json? // Custom theme settings
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  pages      Page[]
  navHeaders NavHeader[] // Top-level header dropdowns (e.g., "Products", "Build", "Manage")

  @@unique([userId, slug])
  @@index([userId])
  @@index([slug])
  @@index([isPublic])
  @@map("docs")
}

// DocItem = Items within a NavHeader dropdown (e.g., "Database", "Auth", "Storage" under "Products")
// NavHeader = Header dropdowns (e.g., "Products", "Build", "Manage", "Reference", "Resources")
model DocItem {
  id          String   @id @default(cuid())
  navHeaderId String   @map("nav_header_id") // Belongs to a NavHeader (header dropdown)
  label       String   // Display name (e.g., "Database", "Auth", "Storage")
  slug        String   // URL-friendly identifier
  description String?  @db.Text
  position    Int      @default(0)
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  navHeader   NavHeader   @relation("DropdownItems", fields: [navHeaderId], references: [id], onDelete: Cascade)
  pages       Page[]
  sections    NavHeader[] @relation("ItemSections") // Sections/subsections within this item

  @@unique([navHeaderId, slug])
  @@index([navHeaderId])
  @@index([position])
  @@map("doc_items")
}

model NavHeader {
  id         String    @id @default(cuid())
  docId      String    @map("doc_id") // Top-level header dropdowns belong to a Doc (required)
  docItemId  String?   @map("doc_item_id") // Optional: sections/subsections belong to a DocItem
  parentId   String?   @map("parent_id") // For subsections within a DocItem
  label      String    // Display name (e.g., "Products" for dropdown, or "Getting Started" for section)
  slug       String
  position   Int       @default(0)
  icon       String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  doc         Doc        @relation(fields: [docId], references: [id], onDelete: Cascade)
  docItem     DocItem?   @relation("ItemSections", fields: [docItemId], references: [id], onDelete: Cascade)
  parent      NavHeader? @relation("HeaderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    NavHeader[] @relation("HeaderHierarchy")
  docItems    DocItem[]  @relation("DropdownItems") // Items within this dropdown (if this is a top-level dropdown, parentId is null)
  pages       Page[]

  @@unique([docId, parentId, slug]) // Unique for top-level dropdowns (parentId is null)
  @@unique([docId, docItemId, parentId, slug]) // Unique for sections within DocItems
  @@index([docId])
  @@index([docItemId])
  @@index([parentId])
  @@index([position])
  @@map("nav_headers")
}

model Page {
  id              String    @id @default(cuid())
  docId           String    @map("doc_id") // Page belongs to a Doc (required)
  docItemId       String?   @map("doc_item_id") // Belongs to a DocItem (item within a dropdown, required when creating pages)
  userId          String    @map("user_id") // Creator/owner
  navHeaderId     String?   @map("nav_header_id") // Optional: Section within a DocItem
  parentId        String?   @map("parent_id") // For nested pages
  title           String
  slug            String
  summary         String?   @db.Text
  content         String    @db.Text
  draftContent    String?   @map("draft_content") @db.Text
  searchIndex     String?   @map("search_index") @db.Text // Full-text search index
  status          String    @default("draft") // 'draft' | 'published'
  position        Int       @default(0)
  viewCount       Int       @default(0) @map("view_count")
  author          String? // Author name for display
  tags            String? // Comma-separated tags
  metaTitle       String?   @map("meta_title")
  metaDescription String?   @map("meta_description") @db.Text
  publishedAt     DateTime? @map("published_at")
  lastEditedBy    String?   @map("last_edited_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  doc       Doc           @relation(fields: [docId], references: [id], onDelete: Cascade)
  docItem   DocItem?      @relation(fields: [docItemId], references: [id], onDelete: Cascade)
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  navHeader NavHeader?    @relation(fields: [navHeaderId], references: [id], onDelete: SetNull)
  parent    Page?         @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Page[]        @relation("PageHierarchy")
  revisions PageRevision[]

  @@unique([docId, docItemId, slug]) // Unique slug per doc/docItem combination
  @@index([docId])
  @@index([docItemId])
  @@index([userId])
  @@index([navHeaderId])
  @@index([parentId])
  @@index([slug])
  @@index([status])
  @@map("pages")
}

model PageRevision {
  id        String   @id @default(cuid())
  pageId    String   @map("page_id")
  userId    String   @map("user_id")
  snapshot  Json
  changeLog String?  @map("change_log") @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  page Page @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pageId])
  @@index([createdAt])
  @@map("page_revisions")
}

model Organization {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  logoUrl      String?  @map("logo_url")
  faviconUrl   String?  @map("favicon_url")
  customDomain String?  @unique @map("custom_domain")
  brandColor   String?  @map("brand_color")
  fontFamily   String?  @map("font_family")
  theme        Json? // Stores custom theme configuration
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("organizations")
}

model PageView {
  id        String   @id @default(cuid())
  pageId    String   @map("page_id")
  userId    String?  @map("user_id")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent") @db.Text
  referrer  String?  @db.Text
  viewedAt  DateTime @default(now()) @map("viewed_at")

  @@index([pageId])
  @@index([userId])
  @@index([viewedAt])
  @@map("page_views")
}

model PageFeedback {
  id        String   @id @default(cuid())
  pageId    String   @map("page_id")
  userId    String?  @map("user_id")
  isHelpful Boolean  @map("is_helpful")
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  @@index([pageId])
  @@index([userId])
  @@map("page_feedback")
}

model SearchQuery {
  id           String   @id @default(cuid())
  userId       String?  @map("user_id")
  query        String
  resultsCount Int      @map("results_count")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@map("search_queries")
}

model ApiKey {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  name       String
  key        String    @unique
  lastUsedAt DateTime? @map("last_used_at")
  expiresAt  DateTime? @map("expires_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([key])
  @@map("api_keys")
}
